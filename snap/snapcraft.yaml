name: scrcpy
title: scrcpy [unofficial]

adopt-info: scrcpy

summary: Display and control your Android device

description: |
  This application provides display and control of Android devices connected on USB (or over TCP/IP). It does not require any root access.  It works on GNU/Linux, Windows and MacOS.
  This is an unofficial snap. The code of scrcpy can be found at: https://github.com/Genymobile/scrcpy

license: Apache-2.0
grade: stable
confinement: strict
compression: lzo

base: core24

platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]
  arm64:
    build-on: [arm64]
    build-for: [arm64]
  armhf:
    build-on: [armhf, arm64]
    build-for: [armhf]

apps:
  scrcpy:
    command: usr/local/bin/scrcpy
    command-chain:
      - bin/desktop-launch
      - bin/scrcpy-launch
    completer: /usr/local/share/bash-completion/completions/scrcpy
    plugs:
      - adb-support
      - alsa
      - audio-playback
      - audio-record
      - camera
      - desktop
      - desktop-legacy
      - home
      - network
      - network-bind
      - opengl
      - pulseaudio
      - raw-usb
      - unity7
      - wayland
      - x11

  adb:
    command: usr/bin/adb
    environment:
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/android/"
    plugs:
      - network-bind
      - raw-usb

layout:
  /usr/local/share/icons:
    symlink: $SNAP/usr/local/share/icons
  /usr/local/share/scrcpy:
    symlink: $SNAP/usr/local/share/scrcpy
  /usr/share/alsa:
    bind: $SNAP/usr/share/alsa
  /usr/share/libdrm:
    bind: $SNAP/usr/share/libdrm

parts:
  scrcpy-server:
    plugin: nil
    build-packages:
      - curl
      - jq
    override-pull: SCRCPY_SERVER_VERSION=2.5 "${CRAFT_PROJECT_DIR}/snap/local/scriptlets/pull-scrcpy-server.sh"
    override-build: |
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/local/share/scrcpy/
      cp scrcpy-server-v* $SNAPCRAFT_PART_INSTALL/usr/local/share/scrcpy/scrcpy-server

  scrcpy:
    source: https://github.com/Genymobile/scrcpy.git
    source-tag: v2.5
    plugin: meson
    meson-parameters:
      - --buildtype=release
      - --strip
      - -Db_lto=true
      - -Dcompile_server=false
    override-pull: |
      craftctl default
      craftctl set version="$(git describe --tag)"
    build-packages:
      - gcc
      - make
      - meson
      - pkg-config
      - ninja-build
      - libavcodec-dev
      - libavdevice-dev
      - libavformat-dev
      - libavutil-dev
      - libsdl2-dev
      - libswresample-dev
      - libusb-1.0-0-dev
    stage-packages:
      - adb
      - ffmpeg
      - libasound2
      - libblas3
      - libglu1-mesa
      - libglut3.12
      - libsdl2-2.0-0
      - libslang2
      - libusb-1.0-0
    stage:
      - -usr/lib/*/libcaca++.so*
      - -usr/lib/*/libcjson_utils.so*
      - -usr/lib/*/libfftw3_omp.so*
      - -usr/lib/*/libfftw3_threads.so*
      - -usr/lib/*/libflite_cmu_grapheme_lang.so*
      - -usr/lib/*/libflite_cmu_grapheme_lex.so*
      - -usr/lib/*/libflite_cmu_indic_lang.so*
      - -usr/lib/*/libflite_cmu_indic_lex.so*
      - -usr/lib/*/libflite_cmu_time_awb.so*
      - -usr/lib/*/libhwy_contrib.so*
      - -usr/lib/*/libhwy_test.so*
      - -usr/lib/*/libicui18n.so*
      - -usr/lib/*/libicuio.so*
      - -usr/lib/*/libicutu.so*
      - -usr/lib/*/libicutest.so*
      - -usr/lib/*/libjacknet.so*
      - -usr/lib/*/libjackserver.so*
      - -usr/lib/*/liboss4-salsa.so*
      - -usr/lib/*/libpulse-simple.so*
      - -usr/lib/*/libsphinxad.so*
      - -usr/lib/*/libtheora.so*
      - -usr/lib/*/libzvbi-chains.so*
      - -usr/share/fonts/truetype/dejavu/*Mono*.ttf
      - -usr/share/fonts/truetype/dejavu/*Bold*.ttf
      - -usr/share/fonts/truetype/dejavu/*Serif*.ttf

  # For enabling SDL applications
  desktop-glib-only:
    build-packages:
      - libglib2.0-dev
    plugin: make
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: glib-only
    stage-packages:
      - libglib2.0-bin

  # Launcher programs to fix problems at runtime
  launchers:
    source: snap/local/launchers
    plugin: dump
    organize:
      '*': bin/
    stage:
      - -bin/README.*
      - -bin/sdl2-notice

  launchers-notice:
    source: snap/local/launchers/sdl2-notice
    plugin: nil
    override-build: |
      craftctl default
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      gcc -o $SNAPCRAFT_PART_INSTALL/bin/sdl2-notice $CRAFT_PROJECT_DIR/snap/local/launchers/sdl2-notice/sdl2-notice.c $(pkg-config --cflags --libs sdl2 SDL2_ttf)
    build-packages:
      - gcc
      - libsdl2-dev
      - libsdl2-ttf-dev
    stage-packages:
      - libsdl2-2.0-0
      - libsdl2-ttf-2.0-0
    stage:
      - -usr/lib/*/libasound.so*
      - -usr/lib/*/libicui18n.so*
      - -usr/lib/*/libicuio.so*
      - -usr/lib/*/libicutu.so*
      - -usr/lib/*/libicutest.so*
      - -usr/lib/*/libpulse-simple.so*

plugs:
  adb:
    interface: content
    target: $SNAP/usr/bin

lint:
  ignore:
    - library:
        # Required by the SDL2 library to prevent the "ERROR: Could not create renderer: Couldn't find matching render driver" error
        - usr/lib/*/libGLX_mesa.so*
        - usr/lib/*/libxcb-glx.so*
